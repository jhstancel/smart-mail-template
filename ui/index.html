<!DOCTYPE html>

<html data-theme="light-minimal" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Smart Mail</title>
<!-- Favicon -->
<link href="img/favicon.png" rel="icon" type="image/png"/>
<!-- (Optional high-res or Apple touch variants)
  <link rel="icon" type="image/svg+xml" href="img/favicon.svg">
  <link rel="apple-touch-icon" href="img/favicon-180.png">
  -->

<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/sahibjotsaggu/SFPro-Fonts/stylesheet.css">
<!-- Inter font (Claude-like clean sans) -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<link rel="stylesheet" href="css/vars.css">
<link rel="stylesheet" href="css/base.css">

<link rel="stylesheet" href="css/layout.css">
<link rel="stylesheet" href="css/components.css">
<link rel="stylesheet" href="css/intents.css">
<link rel="stylesheet" href="css/settings.css">
<link rel="stylesheet" href="css/parts.css">
<link rel="stylesheet" href="css/effects.css">
<link rel="stylesheet" href="css/easter.css">
<link rel="stylesheet" href="css/pets.css">
<link rel="stylesheet" href="css/utilities.css">
<link rel="stylesheet" href="css/responsive.css">
<link rel="stylesheet" href="css/forms.css">
</head>
<body>
<!-- Settings Gear (upper-right) -->
<div class="settings" id="settings">
<button aria-controls="settingsMenu" aria-expanded="false" aria-haspopup="true" class="settings-btn" id="settingsBtn" title="Settings">
<!-- Gear Icon -->
<svg aria-hidden="true" fill="none" height="18" viewbox="0 0 24 24" width="18" xmlns="http://www.w3.org/2000/svg">
<path d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7Z" stroke="currentColor" stroke-width="1.8"></path>
<path d="M19.4 13.1a7.52 7.52 0 0 0 .05-2.21l2.06-1.6-2-3.46-2.49 .57a7.52 7.52 0 0 0-1.92-1.11l-.5-2.53H9.39l-.5 2.53a7.52 7.52 0 0 0-1.92 1.1l-2.49-.56-2 3.46 2.06 1.6a7.52 7.52 0 0 0 0 2.22l-2.06 1.6 2 3.46 2.49-.57c.6 .47 1.24 .85 1.93 1.12l.5 2.53h4.31l.5-2.53c.68-.27 1.33-.65 1.92-1.12l2.49.57 2-3.46-2.06-1.6Z" stroke="currentColor" stroke-width="1.4"></path>
</svg>
<div aria-live="polite" class="splash-tip" id="splashTip" role="status"></div>
</button>
<div aria-label="Settings" class="settings-menu panel" id="settingsMenu" role="menu">
<!-- Item: Theme -->
<div class="settings-item" data-item="theme" role="menuitem" tabindex="0">
<div>
<div class="label">Theme</div>
<div class="hint">Light Minimal, Dark Minimal, Cosmic, Dusk, Forest, Claude Warm</div>
</div>
<svg class="chev" viewbox="0 0 24 24"><path d="M9 6l6 6-6 6" fill="currentColor"></path></svg>
</div>
<div class="settings-subpanel" id="subTheme">
<div class="settings-row">
<label class="muted" for="themeSelect" style="min-width:90px">Preset</label>

<select aria-label="Theme" id="themeSelect">
  <option value="light-minimal">Light Minimal (Default)</option>
  <option value="dark-minimal">Dark Minimal</option>
  <option value="cosmic">Cosmic</option>
  <option value="dusk-gradient">Dusk Gradient</option>
  <option value="forest-mist">Forest Mist</option>
  <option value="pastell">Pastell</option>
  <option value="claude">Claude Warm</option>
</select>
<!-- Descriptions (Verbose/Simple) -->
<div class="settings-row" style="margin-top:10px">
  <label class="muted" for="opt_desc" style="min-width:90px">Display Descriptions</label>
  <div style="display:flex; align-items:center; gap:10px">
    <input id="opt_desc" type="checkbox" />
  </div>
</div>

</div>
</div>
<!-- Item: Typing Animation -->
<div class="settings-item" data-item="typing" role="menuitem" tabindex="0">
<div>
<div class="label">Compose Animation</div>
<div class="hint">Enable or disable live typing effect</div>
</div>
<svg class="chev" viewbox="0 0 24 24"><path d="M9 6l6 6-6 6" fill="currentColor"></path></svg>
</div>
<div class="settings-subpanel" id="subTyping">
<!-- Segmented control -->
<div aria-label="Compose Behavior" class="seg" id="composeSeg" role="tablist">
<button aria-selected="false" class="opt" data-mode="preview" role="tab">Preview</button>
<button aria-selected="false" class="opt" data-mode="type" role="tab">Type</button>
<button aria-selected="false" class="opt" data-mode="off" role="tab">Off</button>
</div>
<p class="muted" style="margin:8px 0 0">Tip: Minimal themes reduce visible animations.</p>
</div>
<div class="settings-item" data-item="intents" role="menuitem" tabindex="0">
<div>
<div class="label">Visible Intents</div>
<div class="hint">Choose which templates appear on the home grid</div>
</div>
<svg class="chev" viewbox="0 0 24 24"><path d="M9 6l6 6-6 6" fill="currentColor"></path></svg>
</div>
<div class="settings-subpanel" id="subIntents">
<div class="kvs" id="intentChecks" style="margin:6px 0 10px"></div>
<div class="inline" style="margin-top:6px">
<button class="btn secondary" id="vi_save" type="button">Save</button>
<button class="btn secondary" id="vi_all" type="button">Select All</button>
<button class="btn secondary" id="vi_none" type="button">Select None</button>
<button class="btn secondary" id="vi_reset" type="button">Reset</button>
</div>
<p class="muted" style="margin:8px 0 0">Tip: “Auto Detect” is always available.</p>
</div>
<div class="settings-item" data-item="usertpls" role="menuitem" tabindex="0">
<div>
<div class="label">My Templates</div>
<div class="hint">Local-only templates saved in this browser</div>
</div>
<svg class="chev" viewbox="0 0 24 24"><path d="M9 6l6 6-6 6" fill="currentColor"></path></svg>
</div>
<div class="settings-subpanel" id="subUserTpls">
<div class="tpl-head">
<div class="label">Templates on this device</div>
<button class="btn small" id="tplNew" type="button">+ New</button>
</div>
<div class="tpl-list" id="userTplList"></div>
<p class="muted" style="margin-top:6px">Tip: These are local only and won’t sync across devices.</p>
</div>
<!-- new Global Defaults section -->
<div class="settings-item" data-item="defaults" role="menuitem" tabindex="0">
<div>
<div class="label">Global Defaults</div>
<div class="hint">Set Ship Address &amp; FedEx Account defaults</div>
</div>
<svg class="chev" viewbox="0 0 24 24"><path d="M9 6l6 6-6 6" fill="currentColor"></path></svg>
</div>
<div class="settings-subpanel" id="subDefaults">
<div class="label" style="margin:8px 0 6px">Global Defaults</div>
<div class="hint" style="margin:-2px 0 10px">Fill these once and we’ll prefill matching fields.</div>
<label style="display:block; font-weight:600; margin:8px 0 4px">Ship Address</label>
<input id="g_shipAddress" placeholder="1457 Merrimon Ave. Asheville, NC 28804" type="text"/>
<div class="inline" style="margin-top:10px">
<label class="toggle"><input id="g_save" type="checkbox"/> Save for this browser</label>
<button class="btn secondary" id="g_apply" type="button">Apply</button>
<button class="btn secondary" id="g_clear" type="button">Clear</button>
</div>
</div>
</div>
</div>


<!-- Pastell pets layer (background) -->
<div id="petFlakes" aria-hidden="true"></div>
<script>
  addEventListener('DOMContentLoaded', () => window.PastellPets?.enable());
</script>
<!-- Cosmic visuals -->
<canvas id="stars"></canvas>
<div class="glow-veil"></div>


<!-- Corruption helpers -->
<div aria-hidden="true" class="corrupt-overlay" id="corruptOverlay"></div>
<div aria-hidden="true" class="flash" id="flash"></div>
<div aria-label="Buffering" aria-modal="true" class="buffer" id="buffer" role="dialog">
<div class="buffer-card">
<div style="font-weight:800; margin-bottom:8px">Reinitializing display&hellip;</div>

<div aria-hidden="true" class="bar"><i id="barFill"></i></div>
<div class="muted" id="barPct" style="margin-top:8px">0%</div>
</div>
</div>
<div aria-hidden="true" class="print-mask" id="printMask"></div>
<div aria-hidden="true" class="print-line" id="printLine"></div>
<div class="wrap" id="appWrap">
<!-- Header -->
<div class="panel reveal">
<h1 class="title">Smart Mail</h1>
<div class="subtitle">Pick an intent. Or use Auto Detect.</div>
<!-- Intent grid -->
<div class="intent-grid" id="intentGrid"></div>
<!-- Auto-detect stage -->
<div class="stage hidden" id="autoStage">
<div class="hr"></div>
<div class="row">
<div>
<label for="to">To (Recipient)</label>
<input id="to" placeholder="buyer@vendor.com" type="email">
</div>
<div>
<label for="subject">Subject (Draft)</label>
<input id="subject" placeholder="RFQ PN-4812" type="text">
</div>
</div>
<div>
<label for="hint">Body Hint (One or Two Lines)</label>
<textarea id="hint" placeholder="Requesting pricing and lead time for PN-4812 quantity five"></textarea>
</div>
<div class="inline" style="margin:10px 0 6px">
<span class="muted" id="predStatus"></span>
</div>
<div class="inline" id="predInfo" style="display:none;margin-top:6px">
<span class="pill">Predicted: <b id="predIntent"></b></span>
<span class="pill" id="predBadge"></span>
<span class="muted" id="predMsg"></span>
</div>
<div class="inline" id="topK" style="gap:6px; flex-wrap:wrap; margin:8px 0 4px"></div>
</div>
</div>
<!-- Fields -->
<div class="panel reveal" style="margin-top:16px">
<div class="inline">
<h2 class="title" id="fieldsTitle" style="font-size:18px; margin:0">Fields</h2>
<span class="subtitle" id="fieldsHint">(Select An Option Or Use Auto Detect)</span>
</div>
<div class="kvs" id="fields"></div>
<div class="inline" style="margin:8px 0">
<button class="btn" id="btnGenerate" type="button">Generate</button>
</div>
</div>
<!-- Output -->
<div class="panel reveal" style="margin-top:16px">
<div class="inline" style="align-items:center; gap:8px">
<h2 class="title" style="font-size:18px; margin:0">Output</h2>
<button class="btn secondary" id="btnEditTemplate" type="button" title="Edit local subject/body template for current intent">✎ Edit Template</button>
<span id="templateOverrideBadge" class="pill" style="display:none" title="Local override active">Override</span>
</div>
<div class="row">
<div>
<label>Subject</label>
<div class="out" id="outSubject"></div>
<div class="inline" style="margin-top:8px">
<button class="btn secondary" id="copySubject">Copy Subject</button>
</div>
</div>
<div>
<label>Body</label>
<div class="out" id="outBody"></div>
<div class="inline" style="margin-top:8px">
<button class="btn secondary" id="copyBody">Copy Body</button>
<button class="btn secondary" id="btnClear">Clear</button>
</div>
</div>
</div>
</div>
</div>

<!-- Simple Editor Dialog for My Templates -->
<dialog id="ut_editor">
  <form id="ut_form" novalidate style="min-width: min(680px, 90vw)">
    <h3 style="margin:0 0 10px">Edit Template</h3>

    <div class="grid" style="display:grid; grid-template-columns:1fr 1fr; gap:10px">
      <label>Backend ID
        <input id="ute_id" type="text" required
               pattern="[A-Za-z0-9_]{2,64}" placeholder="my_quote" />
      </label>

      <label>Label
        <input id="ute_label" type="text" required placeholder="My Quote" />
      </label>
    </div>

    <label>Description
      <input id="ute_desc" type="text" placeholder="Local-only quote request" />
    </label>

<label>Custom Fields (one per line)
  <textarea id="ute_fields" rows="4" placeholder="Examples:
companyName
quantity:number
item:required
partNumber:number:required"></textarea>
</label>

    <div class="grid" style="display:grid; grid-template-columns:1fr; gap:10px; margin-top:6px">
      <label>Subject (use {{field}} placeholders)
        <input id="ute_subject" type="text"
               placeholder="Quote Request — {{ companyName }}: {{ item }}" />
      </label>

      <label>Body (plain text; {{field}} placeholders allowed)
        <textarea id="ute_body" rows="8" placeholder="Hello,

We’d like a quote for {{ item }} (qty {{ quantity }}).

Thanks,"></textarea>
      </label>
    </div>

    <div class="inline" style="justify-content:flex-end; gap:8px; margin-top:10px">
      <button class="btn" id="ute_cancel" type="button" formnovalidate>Cancel</button>
      <button class="btn" id="ute_save"   type="button">Save</button>
    </div>
  </form>
</dialog>


<script>
(() => {
  const ROOT  = document.documentElement;
  const stars = document.getElementById('stars');

  // keep theme persisted (same key as app.js)
  const saved = localStorage.getItem('sm_theme');
  if (saved) ROOT.setAttribute('data-theme', saved);

  const isPastell = () => ROOT.getAttribute('data-theme') === 'pastell';

function applyThemePets(){
  if (isPastell()){
    if (stars) stars.style.display = 'none';
    window.PastellPets?.enable?.();
  } else {
    if (stars) stars.style.display = '';
    window.PastellPets?.disable?.();
  }
}

  // react to theme changes
  const mo = new MutationObserver(applyThemePets);
  mo.observe(ROOT, { attributes:true, attributeFilter:['data-theme'] });

  // user changes via select
  document.getElementById('themeSelect')?.addEventListener('change', e => {
    const val = e.target.value;
    ROOT.setAttribute('data-theme', val);
    localStorage.setItem('sm_theme', val);
  });

  // initial
  applyThemePets();
})();
</script>
<!-- Load pets BEFORE we try to enable them (non-module so it attaches to window) -->
<script src="js/bg/pastell-pets.js"></script>

<!-- Local Template Overrides (non-module; attaches LocalTemplates to window) -->
<script src="js/templates/local-templates.js"></script>

<script>
(function(){
  if (window.__smtFetchWrapped) return;
  window.__smtFetchWrapped = true;

  const origFetch = window.fetch;
  window.fetch = function(input, init){
    try{
      if (typeof input === 'string' &&
          /\/generate\/?$/.test(input) &&
          init && init.method === 'POST' &&
          init.headers && /application\/json/i.test((init.headers['Content-Type'] ?? init.headers.get?.('Content-Type') ?? '')) &&
          init.body) {
        const payload = JSON.parse(init.body);
        const ov = window.LocalTemplates?.get?.(payload.intent);
        if (ov && (ov.subject || ov.body)) {
          payload.templateOverride = { ...(payload.templateOverride || {}) };
          if (ov.subject) payload.templateOverride.subject = ov.subject;
          if (ov.body)    payload.templateOverride.body    = ov.body;
          init.body = JSON.stringify(payload);
        }
      }
    } catch(_) { /* noop */ }
    return origFetch.call(this, input, init);
  };
})();
</script>

<!-- ✨ NEW: Template Editor Modal (slick, in-app) -->
<dialog id="tplEditor" style="padding:0;border:none;border-radius:16px;max-width:min(980px,92vw);width:100%;">
  <form id="tplForm" novalidate style="display:flex;flex-direction:column;gap:0;">
    <div style="display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--line,#ddd);">
      <div style="display:flex;align-items:baseline;gap:10px;">
        <h3 id="tplTitle" style="margin:0;font-size:18px;">Edit Template</h3>
        <span id="tplIntent" class="pill" style="font-size:12px;">intent</span>
      </div>
      <div style="display:flex;gap:8px;">
        <button class="btn secondary" id="tplReset" type="button" title="Reload defaults">Reset to Default</button>
<button class="btn" id="tplSave" type="button">Save</button>
        <button class="btn" id="tplClose" type="button">Close</button>
      </div>
    </div>

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:0;min-height:52vh;">
      <div style="padding:14px 16px;border-right:1px solid var(--line,#eee);display:flex;flex-direction:column;gap:10px;">
        <label style="font-weight:600;">Subject</label>
        <input id="tplSubj" type="text" placeholder="Subject template (Jinja allowed)" style="width:100%;padding:10px;border:1px solid var(--line,#ccc);border-radius:10px;font:inherit;">
        <label style="font-weight:600;margin-top:10px;">Body (Jinja)</label>
        <textarea id="tplBody" placeholder="Email body template" style="flex:1;min-height:280px;width:100%;resize:vertical;padding:10px;border:1px solid var(--line,#ccc);border-radius:10px;font:inherit;font-family:ui-monospace, SFMono-Regular, Menlo, monospace;"></textarea>
      </div>

      <div style="padding:14px 16px;display:flex;flex-direction:column;gap:10px;">
        <label style="font-weight:600;">Preview (raw template text)</label>
        <pre id="tplPreview" style="flex:1;min-height:280px;white-space:pre-wrap;overflow:auto;border:1px solid var(--line,#ccc);border-radius:10px;padding:10px;margin:0;font-family:ui-monospace, SFMono-Regular, Menlo, monospace;"></pre>
        <small style="opacity:.7;">Tip: Preview shows your current edits as plain text. Click <em>Generate</em> to render with fields.</small>
      </div>
    </div>
  </form>
</dialog>

<!-- NEW: editor logic (module) -->
<script type="module" src="js/templates/editor-ui.js"></script>

<!-- User Templates modules -->
<script type="module" src="js/usertpl/store.js"></script>
<script type="module" src="js/usertpl/editor-dialog.js"></script>
<script src="js/usertpl/list-delegation.js"></script>

<!-- Your app (ES module) -->
<script type="module" src="js/main.js"></script>

</body>
</html>

