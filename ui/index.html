<!doctype html>
<html lang="en" data-theme="light-minimal">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Smart Mail</title>
<style>
  /* ===== THEME VARIABLES ===== */
  :root{
    --bg:#ffffff;            /* default: light-minimal */
    --glass:#ffffffcc;
    --ink:#0b1220;
    --muted:#5b677a;
    --accent:#2457ff;
    --accent-2:#3ba3ff;
    --ok:#2ecc71; --warn:#ffb84d; --bad:#ff6b6b;
    --panel-border: rgba(12,16,24,.07);
    --card-bg1: rgba(0,0,0,.02);
    --card-bg2: rgba(0,0,0,.01);
    --card-border: rgba(12,16,24,.08);
    --btn-grad1:#255fff; --btn-grad2:#1846cf;
    --shadow-1: 0 10px 24px rgba(0,0,0,.10);
    --shadow-2: 0 16px 44px rgba(0,0,0,.12);
    --focus-ring: rgba(36,87,255,.14);
    --focus-border: rgba(36,87,255,.55);
  }
  /* Dark-Minimal */
  body[data-theme="dark-minimal"]{
    --bg:#0e1320; --glass:#151c2acc; --ink:#e9eef7; --muted:#a7b3c5;
    --accent:#7ab8ff; --accent-2:#8ee3ff; --panel-border: rgba(255,255,255,.08);
    --card-bg1: rgba(255,255,255,.06); --card-bg2: rgba(255,255,255,.02);
    --card-border: rgba(255,255,255,.10);
    --btn-grad1:#1b67ff; --btn-grad2:#124bcb;
    --shadow-1: 0 10px 30px rgba(0,0,0,.35); --shadow-2: 0 18px 44px rgba(0,0,0,.5);
    --focus-ring: rgba(122,184,255,.10); --focus-border: rgba(122,184,255,.45);
  }
  /* Cosmic (original) */
  body[data-theme="cosmic"]{
    --bg:#0b0f16; --glass:#0f1623cc; --ink:#e9eef7; --muted:#a7b3c5;
    --accent:#7ab8ff; --accent-2:#8ee3ff; --panel-border: rgba(255,255,255,.08);
    --card-bg1: rgba(255,255,255,.06); --card-bg2: rgba(255,255,255,.02);
    --card-border: rgba(255,255,255,.10);
    --btn-grad1:#1b67ff; --btn-grad2:#124bcb;
    --shadow-1: 0 10px 30px rgba(0,0,0,.35); --shadow-2: 0 18px 44px rgba(0,0,0,.5);
    --focus-ring: rgba(122,184,255,.10); --focus-border: rgba(122,184,255,.45);
  }
  /* Dusk Gradient (soft peach/purple) */
  body[data-theme="dusk-gradient"]{
    --bg: linear-gradient(180deg,#fff4ec,#f3f4ff);
    --glass:#ffffffcc; --ink:#0b1220; --muted:#586175;
    --accent:#7a5cff; --accent-2:#ff8fb3; --panel-border: rgba(12,16,24,.07);
    --card-bg1: rgba(0,0,0,.02); --card-bg2: rgba(0,0,0,.01);
    --card-border: rgba(12,16,24,.08);
    --btn-grad1:#6c55ff; --btn-grad2:#4a3ee6; --shadow-1: 0 10px 24px rgba(0,0,0,.10);
    --shadow-2: 0 16px 44px rgba(0,0,0,.12); --focus-ring: rgba(108,85,255,.16);
    --focus-border: rgba(108,85,255,.5);
  }
  /* Forest Mist (cool green/teal) */
  body[data-theme="forest-mist"]{
    --bg: linear-gradient(180deg,#eef8f4,#edf6ff);
    --glass:#ffffffcc; --ink:#0a1612; --muted:#4b5f5a;
    --accent:#1e9e7a; --accent-2:#3cb8a0; --panel-border: rgba(12,16,24,.07);
    --card-bg1: rgba(0,0,0,.02); --card-bg2: rgba(0,0,0,.01);
    --card-border: rgba(12,16,24,.08);
    --btn-grad1:#1e9e7a; --btn-grad2:#167a5e; --shadow-1: 0 10px 24px rgba(0,0,0,.10);
    --shadow-2: 0 16px 44px rgba(0,0,0,.12); --focus-ring: rgba(30,158,122,.16);
    --focus-border: rgba(30,158,122,.5);
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--ink); background:var(--bg);
    font:15px/1.5 Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto;
    overflow-x:hidden;
  }

  /* Starfield */
  canvas#stars{position:fixed; inset:0; z-index:-3;}
  .glow-veil{position:fixed; inset:-10vmax; z-index:-2;
    background: radial-gradient(60vmax 60vmax at 20% -10%, rgba(120,170,255,.12), transparent 60%),
                radial-gradient(50vmax 50vmax at 110% 20%, rgba(120,220,255,.10), transparent 55%),
                radial-gradient(40vmax 35vmax at 40% 120%, rgba(160,140,255,.08), transparent 60%);
    filter: blur(40px); pointer-events:none;
  }
  body:not([data-theme="cosmic"]) canvas#stars,
  body:not([data-theme="cosmic"]) .glow-veil{ display:none; }

  .wrap{max-width:1080px; margin:48px auto; padding:0 20px}
  .panel{
    background:var(--glass);
    -webkit-backdrop-filter: blur(12px);
    backdrop-filter: blur(12px);
    border:1px solid var(--panel-border);
    border-radius:18px;
    box-shadow: var(--shadow-1);
    padding:18px;
  }
  .title{font-weight:800; letter-spacing:.3px; margin:0 0 10px 0; font-size:20px}
  .subtitle{color:var(--muted); margin-top:2px; font-size:13px}

  .intent-grid{ display:grid; gap:12px; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); margin-top:12px; }
  .intent-card{ position:relative; padding:14px; cursor:pointer; border-radius:16px;
    background:linear-gradient(180deg, var(--card-bg1), var(--card-bg2));
    border:1px solid var(--card-border); box-shadow: var(--shadow-1);
    transition: transform .35s cubic-bezier(.2,.7,.2,1), box-shadow .35s ease, border-color .25s ease, filter .25s ease;
    transform-origin:center; overflow:hidden; text-align:left; }
  .intent-card:hover{ transform: translateY(-2px) scale(1.03); box-shadow: var(--shadow-2); border-color: color-mix(in srgb, var(--accent) 25%, transparent); filter: saturate(1.02); }
  .intent-card.active{ transform: translateY(-1px) scale(1.01); box-shadow: var(--shadow-2); border-color: color-mix(in srgb, var(--accent) 25%, transparent); }
  .intent-card.active::after{ content:""; position:absolute; inset:0; border-radius:16px; pointer-events:none; padding:1px;
    background: linear-gradient(120deg, color-mix(in srgb, var(--accent) 0%, transparent) 0%, color-mix(in srgb, var(--accent) 65%, transparent) 12%, color-mix(in srgb, var(--accent) 0%, transparent) 30%) border-box;
    -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
    -webkit-mask-composite: xor; mask-composite: exclude; animation: edgeGlide 3.6s linear infinite; }
  @keyframes edgeGlide { 0% { background-position: 0% 0% } 100% { background-position: 200% 0% } }

  .intent-name{font-weight:800; margin:0 0 6px; letter-spacing:.2px}
  .intent-desc{color:var(--muted); font-size:13px}

  .stage{ margin-top:16px; overflow:hidden; transition: height .45s ease, opacity .45s ease, margin .45s ease; }
  .stage.hidden{ height:0; opacity:0; margin:0; }

  label{display:block; margin:8px 0 6px; font-weight:700; letter-spacing:.2px}
  input[type=text], input[type=email], textarea, select{
    width:100%; color:var(--ink); background:color-mix(in srgb, var(--bg) 90%, black 10%);
    border:1px solid var(--panel-border); border-radius:12px; padding:12px 14px; outline:none;
    box-shadow: 0 0 0 0 rgba(0,0,0,0);
    transition: box-shadow .25s ease, border-color .25s ease, background .25s ease, transform .25s ease;
  }
  input:focus, textarea:focus, select:focus{
    border-color: var(--focus-border); box-shadow: 0 0 0 6px var(--focus-ring); background: color-mix(in srgb, var(--bg) 70%, white 30%);
    transform: translateZ(0) scale(1.01);
  }
  textarea{min-height:90px; resize:vertical}

  .row{display:grid; gap:12px; grid-template-columns:1fr 1fr}
  .kvs{display:grid; gap:10px; grid-template-columns:repeat(auto-fit,minmax(220px,1fr));}
  .muted{color:var(--muted); font-size:12px}
  .pill{padding:4px 10px; border-radius:999px; border:1px solid var(--panel-border); background:color-mix(in srgb, var(--bg) 85%, white 15%);}

  .btn{ background: linear-gradient(180deg, var(--btn-grad1), var(--btn-grad2)); color:white; font-weight:900; letter-spacing:.3px; border:none; border-radius:12px;
    padding:11px 14px; cursor:pointer; box-shadow: 0 10px 30px color-mix(in srgb, var(--btn-grad1) 35%, transparent), 0 0 40px color-mix(in srgb, var(--btn-grad1) 18%, transparent) inset;
    transition: transform .15s ease, box-shadow .25s ease, filter .15s ease; }
  .btn:hover{ transform: translateY(-1px) scale(1.03); filter: brightness(1.03); }
  .btn.secondary{ background:linear-gradient(180deg, var(--card-bg1), var(--card-bg2)); color:var(--ink); border:1px solid var(--card-border); box-shadow:none }

  /* Toast success state (temporary) — lighter green */
  .btn.toast{
    background: linear-gradient(
      180deg,
      color-mix(in srgb, var(--ok) 70%, white 30%),
      color-mix(in srgb, var(--ok) 85%, black 15%)
    ) !important;
    box-shadow: 0 10px 30px color-mix(in srgb, var(--ok) 30%, transparent),
                0 0 40px color-mix(in srgb, var(--ok) 16%, transparent) inset !important;
  }

  .out{white-space:pre-wrap; background:color-mix(in srgb, var(--bg) 90%, black 10%); border:1px solid var(--panel-border); border-radius:12px; padding:12px;}
  .hr{height:1px; background:linear-gradient(90deg, transparent, var(--panel-border), transparent); margin:14px 0 10px 0; border:none;}
  .inline{display:flex; gap:8px; align-items:center; flex-wrap:wrap}

  @media (prefers-reduced-motion: reduce) { .glow-in { animation: none !important; } }
  .glow-in { animation: glowIn 700ms ease-out; }
  @keyframes glowIn { 0% { background: color-mix(in srgb, var(--accent) 14%, transparent) } 100% { background: transparent; } }

  #outSubject, #outBody { min-height: 42px; }
  #outBody .line{ margin: 2px 0; }
  .toggle { display:flex; align-items:center; gap:8px; cursor:pointer; }

  body[data-theme$="minimal"] .intent-card,
  body[data-theme$="minimal"] .btn,
  body[data-theme$="minimal"] input,
  body[data-theme$="minimal"] textarea { transition: none; }
  body[data-theme$="minimal"] .intent-card:hover { transform:none; box-shadow: var(--shadow-1); filter:none; }

  .settings{ position:fixed; top:12px; right:12px; z-index:20; }
  .settings-btn{
    display:flex; align-items:center; justify-content:center; gap:8px;
    width:38px; height:38px; border-radius:12px; border:1px solid var(--panel-border);
    background:color-mix(in srgb, var(--bg) 85%, white 15%);
    box-shadow: var(--shadow-1); cursor:pointer;
    transition: transform .15s ease, box-shadow .25s ease;
    position:relative;
  }
  .settings-btn:hover{ transform: translateY(-1px); box-shadow: var(--shadow-2); }
  .settings-menu{
    margin-top:8px; min-width:260px; max-width:320px;
    display:none; flex-direction:column; gap:8px;
    padding:10px; border-radius:14px; border:1px solid var(--panel-border);
    background:var(--glass); box-shadow: var(--shadow-2);
  }
  .settings-menu.open{ display:flex; }
  .settings-item{
    display:flex; align-items:center; justify-content:space-between; gap:10px;
    border:1px solid var(--card-border); border-radius:12px;
    background:linear-gradient(180deg, var(--card-bg1), var(--card-bg2));
    padding:10px 12px; cursor:pointer;
  }
  .settings-item .label{ font-weight:700; }
  .settings-item .hint{ color:var(--muted); font-size:12px; }

  .settings-subpanel{ overflow:hidden; height:0; opacity:0; transition: height .35s ease, opacity .35s ease, margin .35s ease; margin:0; }
  .settings-subpanel.open{ height:auto; opacity:1; margin-top:6px; }
  .settings-row{ display:flex; align-items:center; gap:10px; }
  .settings-row select{ min-width:200px; }

  .chev{ width:14px; height:14px; transition: transform .25s ease; }
  .rot90{ transform: rotate(90deg); }

  .splash-tip{
    position:absolute; top:46px; right:0;
    background:var(--glass); border:1px solid var(--panel-border);
    box-shadow: var(--shadow-2); border-radius:10px; padding:8px 10px;
    white-space:nowrap; font-weight:800; font-size:12px; color:var(--ink);
    opacity:0; transform: translateY(-6px); pointer-events:none; transition: opacity .2s ease, transform .2s ease;
  }
  .splash-tip.show{ opacity:1; transform: translateY(0); }

  .rabbit{ position:fixed; bottom:18px; left:-40px; width:18px; height:18px; border-radius:50%;
    background:white; box-shadow: 0 0 16px rgba(255,255,255,.8); z-index:30; animation: hop 1.6s ease-in-out forwards; }
  @keyframes hop{
    0%{ transform: translateX(0) translateY(0) }
    20%{ transform: translateX(20vw) translateY(-40px) }
    40%{ transform: translateX(40vw) translateY(0) }
    60%{ transform: translateX(60vw) translateY(-36px) }
    80%{ transform: translateX(80vw) translateY(0) }
    100%{ transform: translateX(105vw) translateY(-48px) }
  }
  .portal{ position:fixed; right:10%; bottom:60px; width:0; height:0; border-radius:50%; z-index:31;
    background: radial-gradient(circle at 50% 50%, rgba(120,220,255,.9), rgba(120,180,255,.25) 40%, transparent 60%);
    filter: blur(2px); animation: portalOpen .6s ease-out forwards; }
  @keyframes portalOpen { to{ width:160px; height:160px; box-shadow: 0 0 60px rgba(120,200,255,.5) inset; } }
  .portal-msg{
    position:fixed; right:calc(10% + 14px); bottom:150px; z-index:32; max-width:320px;
    background:var(--glass); border:1px solid var(--panel-border); padding:10px 12px; border-radius:12px;
    font-weight:800; box-shadow: var(--shadow-2);
    animation: fadeIn .25s ease-out both;
  }
  @keyframes fadeIn { from{ opacity:0; transform: translateY(6px) } to{ opacity:1; transform: translateY(0) } }

  .corrupt-overlay{
    position:fixed; inset:0; z-index:40; pointer-events:none;
    background:
      repeating-linear-gradient(0deg, rgba(255,0,0,.03), rgba(0,255,255,.03) 2px, transparent 3px, transparent 6px),
      radial-gradient(60vmax 60vmax at 50% -10%, rgba(255,255,255,.06), transparent 60%);
    mix-blend-mode: overlay; opacity:.0; transition:opacity .25s ease;
  }
  body.corrupting .corrupt-overlay{ opacity:.9; animation: jitter .15s infinite alternate; }
  body.corrupting{ filter: hue-rotate(20deg) contrast(1.1) saturate(1.2); }
  @keyframes jitter{
    from{ transform: translate(-1px,0) skewX(.3deg) }
    to  { transform: translate(1px,0)  skewX(-.3deg)}
  }

  .flash{ position:fixed; inset:0; background:white; z-index:50; opacity:0; pointer-events:none; }
  .flash.show{ animation: flashbang .7s ease-out both; }
  @keyframes flashbang{ 0%{opacity:0} 20%{opacity:1} 100%{opacity:0} }

  .buffer{
    position:fixed; inset:0; background:color-mix(in srgb, var(--bg) 70%, black 30%); z-index:45; display:none;
    align-items:center; justify-content:center; color:var(--ink);
  }
  .buffer.show{ display:flex; }
  .buffer-card{
    background:var(--glass); border:1px solid var(--panel-border); border-radius:16px; padding:18px; width:min(520px, 90vw);
    box-shadow: var(--shadow-2); text-align:center;
  }
  .bar{ height:10px; border-radius:10px; background:color-mix(in srgb, var(--bg) 85%, white 15%); overflow:hidden; border:1px solid var(--panel-border); }
  .bar > i{ display:block; height:100%; width:0%; background: linear-gradient(90deg, var(--accent), var(--accent-2)); }

  .print-mask{ position:fixed; inset:0; background:var(--bg); z-index:44; display:none; }
  .print-mask.show{ display:block; animation: printReveal 2.4s steps(24) forwards .2s; }
  @keyframes printReveal{
    from{ clip-path: inset(0 0 100% 0); }
    to{   clip-path: inset(100% 0 0 0); }
  }
  .print-line{
    position:fixed; left:0; right:0; top:0; height:2px; z-index:46; background: color-mix(in srgb, var(--ink) 40%, transparent);
    display:none;
  }
  .print-line.show{ display:block; animation: lineSweep 2.4s linear forwards .2s; }
  @keyframes lineSweep{
    from{ transform: translateY(0) }
    to{ transform: translateY(100vh) }
  }
</style>
</head>
<body>
<div class="settings" id="settings">
  <button id="settingsBtn" class="settings-btn" aria-haspopup="true" aria-expanded="false" aria-controls="settingsMenu" title="Settings">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
      <path d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7Z" stroke="currentColor" stroke-width="1.8"/>
      <path d="M19.4 13.1a7.52 7.52 0 0 0 .05-2.21l2.06-1.6-2-3.46-2.49 .57a7.52 7.52 0 0 0-1.92-1.11l-.5-2.53H9.39l-.5 2.53a7.52 7.52 0 0 0-1.92 1.1l-2.49-.56-2 3.46 2.06 1.6a7.52 7.52 0 0 0 0 2.22l-2.06 1.6 2 3.46 2.49-.57c.6 .47 1.24 .85 1.93 1.12l.5 2.53h4.31l.5-2.53c.68-.27 1.33-.65 1.92-1.12l2.49.57 2-3.46-2.06-1.6Z" stroke="currentColor" stroke-width="1.4"/>
    </svg>
    <div id="splashTip" class="splash-tip" role="status" aria-live="polite"></div>
  </button>
  <div id="settingsMenu" class="settings-menu panel" role="menu" aria-label="Settings">
    <div class="settings-item" data-item="theme" role="menuitem" tabindex="0">
      <div>
        <div class="label">Theme</div>
        <div class="hint">Light Minimal, Dark Minimal, Cosmic, Dusk, Forest</div>
      </div>
      <svg class="chev" viewBox="0 0 24 24"><path fill="currentColor" d="M9 6l6 6-6 6"/></svg>
    </div>
    <div id="subTheme" class="settings-subpanel">
      <div class="settings-row">
        <label for="themeSelect" class="muted" style="min-width:90px">Preset</label>
        <select id="themeSelect" aria-label="Theme">
          <option value="light-minimal">Light Minimal (Default)</option>
          <option value="dark-minimal">Dark Minimal</option>
          <option value="cosmic">Cosmic</option>
          <option value="dusk-gradient">Dusk Gradient</option>
          <option value="forest-mist">Forest Mist</option>
        </select>
      </div>
    </div>

    <div class="settings-item" data-item="typing" role="menuitem" tabindex="0">
      <div>
        <div class="label">Compose Animation</div>
        <div class="hint">Enable or disable live typing effect</div>
      </div>
      <svg class="chev" viewBox="0 0 24 24"><path fill="currentColor" d="M9 6l6 6-6 6"/></svg>
    </div>
    <div id="subTyping" class="settings-subpanel">
      <label class="toggle" for="liveCompose" style="margin-top:2px">
        <input id="liveCompose" type="checkbox" checked /> Compose Live
      </label>
      <p class="muted" style="margin:6px 0 0">Note: Minimal themes dampen most animations.</p>
    </div>
  </div>
</div>

<canvas id="stars"></canvas>
<div class="glow-veil"></div>

<div id="corruptOverlay" class="corrupt-overlay" aria-hidden="true"></div>
<div id="flash" class="flash" aria-hidden="true"></div>
<div id="buffer" class="buffer" role="dialog" aria-modal="true" aria-label="Buffering">
  <div class="buffer-card">
    <div style="font-weight:800; margin-bottom:8px">Reinitializing display…</div>
    <div class="bar" aria-hidden="true"><i id="barFill"></i></div>
    <div id="barPct" class="muted" style="margin-top:8px">0%</div>
  </div>
</div>
<div id="printMask" class="print-mask" aria-hidden="true"></div>
<div id="printLine" class="print-line" aria-hidden="true"></div>

<div class="wrap" id="appWrap">
  <div class="panel reveal">
    <h1 class="title">Smart Mail</h1>
    <div class="subtitle">Pick an intent. Or use Auto Detect.</div>

    <div id="intentGrid" class="intent-grid"></div>

    <div id="autoStage" class="stage hidden">
      <div class="hr"></div>
      <div class="row">
        <div>
          <label for="to">To (Recipient)</label>
          <input id="to" type="email" placeholder="buyer@vendor.com" />
        </div>
        <div>
          <label for="subject">Subject (Draft)</label>
          <input id="subject" type="text" placeholder="RFQ PN-4812" />
        </div>
      </div>
      <div>
        <label for="hint">Body Hint (One or Two Lines)</label>
        <textarea id="hint" placeholder="Requesting pricing and lead time for PN-4812 quantity five"></textarea>
      </div>
      <div class="inline" style="margin:10px 0 6px">
        <button id="btnPredict" class="btn">Auto Detect Intent</button>
        <span id="predStatus" class="muted"></span>
      </div>
      <div id="predInfo" class="inline" style="display:none;margin-top:6px">
        <span class="pill">Predicted: <b id="predIntent"></b></span>
        <span id="predBadge" class="pill"></span>
        <span id="predMsg" class="muted"></span>
      </div>
      <div id="topK" class="inline" style="gap:6px; flex-wrap:wrap; margin:8px 0 4px"></div>
    </div>
  </div>

  <div class="panel reveal" style="margin-top:16px">
    <div class="inline">
      <h2 class="title" style="font-size:18px; margin:0">Fields</h2>
      <span class="subtitle" id="fieldsHint">(Select An Option Or Use Auto Detect)</span>
      <span id="health" class="muted" style="margin-left:auto"></span>
    </div>
    <div id="fields" class="kvs"></div>
    <div class="inline" style="margin:8px 0">
      <button id="btnGenerate" class="btn">Generate</button>
      <span id="missing" class="muted"></span>
    </div>
  </div>

  <div class="panel reveal" style="margin-top:16px">
    <div class="inline">
      <h2 class="title" style="font-size:18px; margin:0">Output</h2>
      <span class="subtitle">Copy into your email client</span>
    </div>
    <div class="row">
      <div>
        <label>Subject</label>
        <div id="outSubject" class="out"></div>
        <div class="inline" style="margin-top:8px">
          <button id="copySubject" class="btn secondary">Copy Subject</button>
        </div>
      </div>
      <div>
        <label>Body</label>
        <div id="outBody" class="out"></div>
        <div class="inline" style="margin-top:8px">
          <button id="copyBody" class="btn secondary">Copy Body</button>
          <button id="btnClear" class="btn secondary">Clear</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/* ===== Starfield ===== */
const Starfield = (function(){
  const c = document.getElementById('stars');
  const ctx = c.getContext('2d');
  const dpr = Math.min(2, window.devicePixelRatio || 1);
  let stars=[], rafId=null, running=false;
  function resize(){ c.width=innerWidth*dpr; c.height=innerHeight*dpr; ctx.setTransform(dpr,0,0,dpr,0,0); }
  function init(){ stars = []; const count = Math.floor((innerWidth*innerHeight)/9000);
    for(let i=0;i<count;i++){ stars.push({x:Math.random()*innerWidth, y:Math.random()*innerHeight, r:Math.random()*1.2+0.2, a:Math.random()*0.4+0.4, v:Math.random()*0.04+0.01}); } }
  function draw(){ if(!running) return; ctx.clearRect(0,0,innerWidth,innerHeight);
    stars.forEach(s=>{ s.y+=s.v; if(s.y>innerHeight) s.y=-5; ctx.beginPath(); ctx.arc(s.x, s.y, s.r, 0, Math.PI*2); ctx.fillStyle=`rgba(200,230,255,${s.a})`; ctx.fill(); });
    rafId = requestAnimationFrame(draw);
  }
  function start(){ if(running) return; running=true; resize(); init(); draw(); }
  function stop(){ running=false; if(rafId) cancelAnimationFrame(rafId); }
  window.addEventListener('resize', ()=>{ if(running){ resize(); init(); }});
  return { start, stop };
})();

/* ===== Utilities ===== */
const $ = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);
const toTitle = (key) => key.replace(/[\-_]+/g,' ').replace(/([a-z])([A-Z])/g,'$1 $2').replace(/\s+/g,' ').trim().split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1).toLowerCase()).join(' ');
function badge(score, thr=0.55){ const pct = Math.round(score*100); let cls='pill'; if(score>=thr) cls+=' ok'; else if(score>=0.45) cls+=' warn'; else cls+=' bad'; return `<span class="${cls}">${pct}%</span>`; }
function delay(ms){ return new Promise(r=>setTimeout(r,ms)); }

/* ===== Elements & state ===== */
const intentGrid = $('#intentGrid');
const autoStage = $('#autoStage');
const fieldsWrap = $('#fields');
const fieldsHint = $('#fieldsHint');
const predInfo = $('#predInfo');
const predIntent = $('#predIntent');
const predMsg = $('#predMsg');
const predStatus = $('#predStatus');
const topK = $('#topK');
const outSubject = $('#outSubject');
const outBody = $('#outBody');
const health = $('#health');
const themeSelect = $('#themeSelect');

const splashTip = $('#splashTip');
const settingsBtn = $('#settingsBtn');
const settingsMenu = $('#settingsMenu');
const itemTheme = document.querySelector('.settings-item[data-item="theme"]');
const itemTyping = document.querySelector('.settings-item[data-item="typing"]');
const subTheme = $('#subTheme');
const subTyping = $('#subTyping');

const flashEl = $('#flash');
const bufferEl = $('#buffer');
const barFill = $('#barFill');
const barPct = $('#barPct');
const printMask = $('#printMask');
const printLine = $('#printLine');

let SCHEMA = {};
let SELECTED_INTENT = null;
let CONF_THR = 0.55;
let prevSubject = '';
let prevBody = '';

/* ===== Intent descriptions ===== */
const INTENT_DESCS = {
  quote_request: "Ask For Pricing Or Lead Time.",
  shipment_update: "Send Tracking, Carrier, Ship Date.",
  order_confirmation: "Acknowledge Or Confirm A PO.",
  invoice_payment: "Payment Or Invoice Notice.",
  delay_notice: "Notify A Date Change Or Backorder.",
  packing_slip_docs: "Send Documents: Packing Slip, COO, SDS.",
  followup: "Polite Nudge Or Status Check.",
  auto_detect: "Let The System Read Your Draft And Suggest An Intent."
};

/* ===== Splashes ===== */
const SPLASHES = [
  "Punching trees!", "Now with 100% more blocks!", "Yaaay clouds!", "So fresh, so clean!",
  "The cake is a lie!", "Much wow, very block!", "Mind the Creepers!", "Don’t dig straight down!",
  "Redstone-ready!", "Hardcore, baby!", "Plenty of sheep!", "Spelunk responsibly!",
  "Watch your step!", "Embrace the grind!", "Chickens gonna cluck!", "Piglin approved!",
  "Blocks on blocks!", "Boats go brrr!", "Suspicious stew?!", "Keep calm and craft on!",
  "Enchanting vibes!", "Bee yourself!", "Mine all day!", "Build all night!",
  "Nether? I hardly know her!", "Cave update feelings!", "RTX? Very shiny!", "Punch wood → Profit!",
  "Mending your ways!", "Eat your golden carrots!", "Warden says hi…", "Fortune favors you!",
  "Adventure awaits!", "Stay blocky!", "Better than diamonds?", "Creeper? …Aww man.",
  "Remember your bed!", "Set your spawn!", "Hiss-terical!", "Powered rails zoom!"
];

/* ===== Intent grid ===== */
function intentCard(name){
  const div = document.createElement('div');
  div.className = 'intent-card';
  const label = (name==='auto_detect') ? 'Auto Detect' : toTitle(name.replaceAll('_',' '));
  div.innerHTML = `
    <div class="intent-name">${label}</div>
    <div class="intent-desc">${INTENT_DESCS[name]||''}</div>
  `;
  div.addEventListener('click', ()=>{
    const isActive = div.classList.contains('active');
    document.querySelectorAll('.intent-card').forEach(x=>x.classList.remove('active'));
    if(isActive){ SELECTED_INTENT = null; renderFields(null); autoStage.classList.add('hidden'); return; }
    div.classList.add('active');
    if(name==='auto_detect'){ autoStage.classList.remove('hidden'); setSelectedIntent(null); }
    else { autoStage.classList.add('hidden'); setSelectedIntent(name); }
  });
  return div;
}
function renderIntentGrid(){
  intentGrid.innerHTML = '';
  const order = ["quote_request","shipment_update","order_confirmation","invoice_payment","delay_notice","packing_slip_docs","followup"];
  order.forEach(i => intentGrid.appendChild(intentCard(i)));
  const auto = intentCard('auto_detect');
  auto.style.background = 'linear-gradient(180deg, var(--card-bg1), var(--card-bg2))';
  intentGrid.appendChild(auto);
}

/* ===== Fields ===== */
function renderFields(intent){
  fieldsWrap.innerHTML = '';
  if(!intent || !SCHEMA[intent]){ fieldsHint.textContent = '(Select An Option Or Use Auto Detect)'; return; }
  const req = SCHEMA[intent].required || [];
  const niceList = req.map(toTitle).join(', ');
  fieldsHint.textContent = req.length ? `Required Fields: ${niceList}` : 'No Required Fields';

  for(const key of req){
    const wrap = document.createElement('div'); wrap.className = 'kv';
    const label = document.createElement('label'); label.textContent = toTitle(key);
    const input = document.createElement('input'); input.type = 'text'; input.id = `f_${key}`; input.placeholder = toTitle(key);
    wrap.appendChild(label); wrap.appendChild(input); fieldsWrap.appendChild(wrap);
  }
}
function collectFields(intent){ const req = SCHEMA[intent]?.required || []; const fields = {}; for(const key of req){ const el = document.getElementById(`f_${key}`); fields[key] = el ? (el.value || '') : ''; } return fields; }
function setSelectedIntent(name){ SELECTED_INTENT = name || null; renderFields(SELECTED_INTENT); }

/* ===== API ===== */
async function getJSON(u){ const r = await fetch(u); return r.json(); }
async function postJSON(u,d){ const r = await fetch(u, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(d)}); return r.json(); }

/* ===== Live typing animation ===== */
function setTextInstant(el, text){ el.textContent = text || ''; el.classList.add('glow-in'); setTimeout(()=>el.classList.remove('glow-in'), 700); }
async function typeLine(el, text, maxMs=500){
  const live = document.getElementById('liveCompose')?.checked !== false; const reduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
  if (!live || reduced || document.body.dataset.theme.endsWith('minimal')) return setTextInstant(el, text);
  el.textContent = '';
  const t0 = performance.now(); const total = text.length; let i = 0; const step = Math.max(1, Math.ceil(total / Math.max(1, maxMs/16)));
  return new Promise(resolve=>{ function tick(ts){ i = Math.min(total, i + step); el.textContent = text.slice(0, i); if (i >= total || (ts - t0) >= maxMs) { el.textContent = text; el.classList.add('glow-in'); setTimeout(()=>el.classList.remove('glow-in'), 700); resolve(); } else requestAnimationFrame(tick); } requestAnimationFrame(tick); });
}
async function typeSubjectAndBody(newSubject, newBody){
  const live = document.getElementById('liveCompose')?.checked !== false; const reduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches; const minimal = document.body.dataset.theme.endsWith('minimal');
  if (!live || reduced || minimal) setTextInstant(outSubject, newSubject); else await typeLine(outSubject, newSubject, 350);
  const lines = (newBody || '').split('\n'); outBody.innerHTML = lines.map(()=>'<div class="line"></div>').join(''); const nodes = [...outBody.querySelectorAll('.line')];
  for (let i=0; i<lines.length; i++){ if (!live || reduced || minimal) setTextInstant(nodes[i], lines[i]); else await typeLine(nodes[i], lines[i], 450); }
  prevSubject = newSubject; prevBody = newBody;
}

/* ===== Toast helper (keeps width) ===== */
function flashToast(btn, text='Copied!'){
  if(!btn) return;
  const originalText = btn.textContent;
  const originalWidth = btn.offsetWidth;           // lock current width
  btn.style.width = originalWidth + 'px';
  btn.classList.add('toast');
  btn.textContent = text;
  setTimeout(()=>{
    btn.classList.remove('toast');
    btn.textContent = originalText;
    btn.style.width = '';                          // release width lock
  }, 1100);
}

/* ===== Clear ===== */
function clearAll(){
  document.querySelectorAll('input[type="text"], input[type="email"], textarea').forEach(el => el.value = '');
  outSubject.textContent = '';
  outBody.textContent = '';
  predStatus.textContent = '';
  predInfo.style.display = 'none';
  topK.innerHTML = '';
  document.querySelectorAll('.intent-card').forEach(x=>x.classList.remove('active'));
  SELECTED_INTENT = null;
  renderFields(null);
}

/* ===== Copy / Clear buttons ===== */
async function copyText(t){ try{ await navigator.clipboard.writeText(t); }catch(e){} }
$('#copySubject').addEventListener('click', (e)=>{ copyText(outSubject.textContent); flashToast(e.currentTarget, 'Copied!'); });
$('#copyBody').addEventListener('click',   (e)=>{ copyText(outBody.textContent);   flashToast(e.currentTarget, 'Copied!'); });
$('#btnClear').addEventListener('click',   (e)=>{ clearAll();                       flashToast(e.currentTarget, 'Cleared!'); });

/* ===== Predict / Generate ===== */
$('#btnPredict').addEventListener('click', async ()=>{
  predStatus.textContent = 'Detecting…'; predInfo.style.display = 'none'; topK.innerHTML='';
  const to = $('#to').value, subject = $('#subject').value, hint = $('#hint').value;
  const res = await postJSON('/predict', {to, subject, body_hint: hint});
  predStatus.textContent = ''; predInfo.style.display = 'flex';
  $('#predIntent').textContent = res.intent ? toTitle(res.intent.replaceAll('_',' ')) : '—';
  const holder = document.createElement('span'); holder.innerHTML = badge(res.confidence, CONF_THR);
  const old = document.getElementById('predBadge'); if(old) old.replaceWith(holder); holder.id='predBadge';
  $('#predMsg').textContent = res.message || '';
  topK.innerHTML = '';
  (res.top_k||[]).forEach(([name,score])=>{
    const b = document.createElement('button'); b.className = 'btn secondary'; b.textContent = `${toTitle(name.replaceAll('_',' '))} (${Math.round(score*100)}%)`;
    b.addEventListener('click', ()=> {
      document.querySelectorAll('.intent-card').forEach(x=>x.classList.remove('active'));
      [...document.querySelectorAll('.intent-card')].find(x=>x.querySelector('.intent-name')?.textContent===toTitle(name.replaceAll('_',' ')))?.classList.add('active');
      setSelectedIntent(name);
      window.scrollTo({ top: document.body.scrollHeight/3, behavior: 'smooth' });
    });
    topK.appendChild(b);
  });
});
$('#btnGenerate').addEventListener('click', async ()=>{
  if(!SELECTED_INTENT){ $('#missing').textContent = 'Select An Option (Or Auto Detect) First.'; return; }
  const fields = collectFields(SELECTED_INTENT);
  const res = await postJSON('/generate', { intent: SELECTED_INTENT, fields });
  const missing = (res.missing && res.missing.length) ? res.missing.map(toTitle).join(', ') : '';
  $('#missing').textContent = missing ? `Missing: ${missing}` : '';
  await typeSubjectAndBody(res.subject||'', res.body||'');
});

/* ===== Theme & settings ===== */
function applyTheme(val){ document.body.setAttribute('data-theme', val); if(val === 'cosmic') Starfield.start(); else Starfield.stop(); }
function closeAllSubs(){ [subTheme, subTyping].forEach(s=> s.classList.remove('open')); document.querySelectorAll('.settings-item .chev').forEach(c=> c.classList.remove('rot90')); }
function openOnly(panel, chev){ closeAllSubs(); panel.classList.add('open'); chev.classList.add('rot90'); }
const settingsBtnEl = document.getElementById('settingsBtn');
settingsBtnEl.addEventListener('click', ()=>{ const isOpen = settingsMenu.classList.toggle('open'); settingsBtn.setAttribute('aria-expanded', String(isOpen)); if(!isOpen) closeAllSubs(); });
itemTheme.addEventListener('click', ()=> openOnly(subTheme, itemTheme.querySelector('.chev')));
itemTyping.addEventListener('click', ()=> openOnly(subTyping, itemTyping.querySelector('.chev')));
window.addEventListener('click', (e)=>{ if(!settingsMenu.contains(e.target) && !settingsBtn.contains(e.target)){ settingsMenu.classList.remove('open'); settingsBtn.setAttribute('aria-expanded','false'); closeAllSubs(); }});

/* Splash tooltip */
let splashTimer=null;
settingsBtn.addEventListener('mouseenter', ()=>{
  splashTimer = setTimeout(()=>{
    splashTip.textContent = SPLASHES[Math.floor(Math.random()*SPLASHES.length)];
    splashTip.classList.add('show');
  }, 1200);
});
settingsBtn.addEventListener('mouseleave', ()=>{
  clearTimeout(splashTimer); splashTip.classList.remove('show');
});

/* Easter eggs omitted for brevity in this snippet (unchanged from your file) */

/* ===== Init ===== */
(async function init(){
  applyTheme('light-minimal');
  if(themeSelect) themeSelect.value = 'light-minimal';
  renderIntentGrid();

  try{
    const h = await getJSON('/health');
    CONF_THR = h.confidence_threshold || 0.55;
    health.textContent = `Model: ${(h.model_classes||[]).length} intents • Threshold ${Math.round(CONF_THR*100)}%`;
    SCHEMA = await getJSON('/schema');
  }catch(e){ health.textContent = 'Server Not Reachable'; }
})();
</script>
</body>
</html>

