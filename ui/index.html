<!DOCTYPE html>

<html data-theme="light-minimal" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Smart Mail</title>
<!-- Favicon -->
<link href="img/favicon.png" rel="icon" type="image/png"/>
<!-- (Optional high-res or Apple touch variants)
  <link rel="icon" type="image/svg+xml" href="img/favicon.svg">
  <link rel="apple-touch-icon" href="img/favicon-180.png">
  -->

<link href="styles.css" rel="stylesheet"/></head>
<body>
<!-- Settings Gear (upper-right) -->
<div class="settings" id="settings">
<button aria-controls="settingsMenu" aria-expanded="false" aria-haspopup="true" class="settings-btn" id="settingsBtn" title="Settings">
<!-- Gear Icon -->
<svg aria-hidden="true" fill="none" height="18" viewbox="0 0 24 24" width="18" xmlns="http://www.w3.org/2000/svg">
<path d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7Z" stroke="currentColor" stroke-width="1.8"></path>
<path d="M19.4 13.1a7.52 7.52 0 0 0 .05-2.21l2.06-1.6-2-3.46-2.49 .57a7.52 7.52 0 0 0-1.92-1.11l-.5-2.53H9.39l-.5 2.53a7.52 7.52 0 0 0-1.92 1.1l-2.49-.56-2 3.46 2.06 1.6a7.52 7.52 0 0 0 0 2.22l-2.06 1.6 2 3.46 2.49-.57c.6 .47 1.24 .85 1.93 1.12l.5 2.53h4.31l.5-2.53c.68-.27 1.33-.65 1.92-1.12l2.49.57 2-3.46-2.06-1.6Z" stroke="currentColor" stroke-width="1.4"></path>
</svg>
<div aria-live="polite" class="splash-tip" id="splashTip" role="status"></div>
</button>
<div aria-label="Settings" class="settings-menu panel" id="settingsMenu" role="menu">
<!-- Item: Theme -->
<div class="settings-item" data-item="theme" role="menuitem" tabindex="0">
<div>
<div class="label">Theme</div>
<div class="hint">Light Minimal, Dark Minimal, Cosmic, Dusk, Forest</div>
</div>
<svg class="chev" viewbox="0 0 24 24"><path d="M9 6l6 6-6 6" fill="currentColor"></path></svg>
</div>
<div class="settings-subpanel" id="subTheme">
<div class="settings-row">
<label class="muted" for="themeSelect" style="min-width:90px">Preset</label>

<select aria-label="Theme" id="themeSelect">
  <option value="light-minimal">Light Minimal (Default)</option>
  <option value="dark-minimal">Dark Minimal</option>
  <option value="cosmic">Cosmic</option>
  <option value="dusk-gradient">Dusk Gradient</option>
  <option value="forest-mist">Forest Mist</option>
  <option value="pastell">Pastell</option>
</select>

</div>
</div>
<!-- Item: Typing Animation -->
<div class="settings-item" data-item="typing" role="menuitem" tabindex="0">
<div>
<div class="label">Compose Animation</div>
<div class="hint">Enable or disable live typing effect</div>
</div>
<svg class="chev" viewbox="0 0 24 24"><path d="M9 6l6 6-6 6" fill="currentColor"></path></svg>
</div>
<div class="settings-subpanel" id="subTyping">
<!-- Segmented control -->
<div aria-label="Compose Behavior" class="seg" id="composeSeg" role="tablist">
<button aria-selected="false" class="opt" data-mode="preview" role="tab">Preview</button>
<button aria-selected="false" class="opt" data-mode="type" role="tab">Type</button>
<button aria-selected="false" class="opt" data-mode="off" role="tab">Off</button>
</div>
<p class="muted" style="margin:8px 0 0">Tip: Minimal themes reduce visible animations.</p>
</div>
<div class="settings-item" data-item="intents" role="menuitem" tabindex="0">
<div>
<div class="label">Visible Intents</div>
<div class="hint">Choose which templates appear on the home grid</div>
</div>
<svg class="chev" viewbox="0 0 24 24"><path d="M9 6l6 6-6 6" fill="currentColor"></path></svg>
</div>
<div class="settings-subpanel" id="subIntents">
<div class="kvs" id="intentChecks" style="margin:6px 0 10px"></div>
<div class="inline" style="margin-top:6px">
<button class="btn secondary" id="vi_save" type="button">Save</button>
<button class="btn secondary" id="vi_all" type="button">Select All</button>
<button class="btn secondary" id="vi_none" type="button">Select None</button>
<button class="btn secondary" id="vi_reset" type="button">Reset</button>
</div>
<p class="muted" style="margin:8px 0 0">Tip: “Auto Detect” is always available.</p>
</div>
<div class="settings-item" data-item="usertpls" role="menuitem" tabindex="0">
<div>
<div class="label">My Templates</div>
<div class="hint">Local-only templates saved in this browser</div>
</div>
<svg class="chev" viewbox="0 0 24 24"><path d="M9 6l6 6-6 6" fill="currentColor"></path></svg>
</div>
<div class="settings-subpanel" id="subUserTpls">
<div class="tpl-head">
<div class="label">Templates on this device</div>
<button class="btn small" id="tplNew" type="button">+ New</button>
</div>
<div class="tpl-list" id="userTplList"></div>
<p class="muted" style="margin-top:6px">Tip: These are local only and won’t sync across devices.</p>
</div>
<!-- new Global Defaults section -->
<div class="settings-item" data-item="defaults" role="menuitem" tabindex="0">
<div>
<div class="label">Global Defaults</div>
<div class="hint">Set Ship Address &amp; FedEx Account defaults</div>
</div>
<svg class="chev" viewbox="0 0 24 24"><path d="M9 6l6 6-6 6" fill="currentColor"></path></svg>
</div>
<div class="settings-subpanel" id="subDefaults">
<div class="label" style="margin:8px 0 6px">Global Defaults</div>
<div class="hint" style="margin:-2px 0 10px">Fill these once and we’ll prefill matching fields.</div>
<label style="display:block; font-weight:600; margin:8px 0 4px">Ship Address</label>
<input id="g_shipAddress" placeholder="1457 Merrimon Ave. Asheville, NC 28804" type="text"/>
<div class="inline" style="margin-top:10px">
<label class="toggle"><input id="g_save" type="checkbox"/> Save for this browser</label>
<button class="btn secondary" id="g_apply" type="button">Apply</button>
<button class="btn secondary" id="g_clear" type="button">Clear</button>
</div>
</div>
</div>
</div>


<!-- Pastell pets layer (background) -->
<div id="petFlakes" aria-hidden="true"
     style="position:fixed; inset:0; z-index:-1; overflow:hidden; display:none; pointer-events:none;"></div>

<!-- Cosmic visuals -->
<canvas id="stars"></canvas>
<div class="glow-veil"></div>


<!-- Corruption helpers -->
<div aria-hidden="true" class="corrupt-overlay" id="corruptOverlay"></div>
<div aria-hidden="true" class="flash" id="flash"></div>
<div aria-label="Buffering" aria-modal="true" class="buffer" id="buffer" role="dialog">
<div class="buffer-card">
<div style="font-weight:800; margin-bottom:8px">Reinitializing displayâ€¦</div>
<div aria-hidden="true" class="bar"><i id="barFill"></i></div>
<div class="muted" id="barPct" style="margin-top:8px">0%</div>
</div>
</div>
<div aria-hidden="true" class="print-mask" id="printMask"></div>
<div aria-hidden="true" class="print-line" id="printLine"></div>
<div class="wrap" id="appWrap">
<!-- Header -->
<div class="panel reveal">
<h1 class="title">Smart Mail</h1>
<div class="subtitle">Pick an intent. Or use Auto Detect.</div>
<!-- Intent grid -->
<div class="intent-grid" id="intentGrid"></div>
<!-- Auto-detect stage -->
<div class="stage hidden" id="autoStage">
<div class="hr"></div>
<div class="row">
<div>
<label for="to">To (Recipient)</label>
<input id="to" placeholder="buyer@vendor.com" type="email">
</input></div>
<div>
<label for="subject">Subject (Draft)</label>
<input id="subject" placeholder="RFQ PN-4812" type="text">
</input></div>
</div>
<div>
<label for="hint">Body Hint (One or Two Lines)</label>
<textarea id="hint" placeholder="Requesting pricing and lead time for PN-4812 quantity five"></textarea>
</div>
<div class="inline" style="margin:10px 0 6px">
<span class="muted" id="predStatus"></span>
</div>
<div class="inline" id="predInfo" style="display:none;margin-top:6px">
<span class="pill">Predicted: <b id="predIntent"></b></span>
<span class="pill" id="predBadge"></span>
<span class="muted" id="predMsg"></span>
</div>
<div class="inline" id="topK" style="gap:6px; flex-wrap:wrap; margin:8px 0 4px"></div>
</div>
</div>
<!-- Fields -->
<div class="panel reveal" style="margin-top:16px">
<div class="inline">
<h2 class="title" id="fieldsTitle" style="font-size:18px; margin:0">Fields</h2>
<span class="subtitle" id="fieldsHint">(Select An Option Or Use Auto Detect)</span>
</div>
<div class="kvs" id="fields"></div>
<div class="inline" style="margin:8px 0">
<button class="btn" id="btnGenerate" type="button">Generate</button>
</div>
</div>
<!-- Output -->
<div class="panel reveal" style="margin-top:16px">
<div class="inline">
<h2 class="title" style="font-size:18px; margin:0">Output</h2>
</div>
<div class="row">
<div>
<label>Subject</label>
<div class="out" id="outSubject"></div>
<div class="inline" style="margin-top:8px">
<button class="btn secondary" id="copySubject">Copy Subject</button>
</div>
</div>
<div>
<label>Body</label>
<div class="out" id="outBody"></div>
<div class="inline" style="margin-top:8px">
<button class="btn secondary" id="copyBody">Copy Body</button>
<button class="btn secondary" id="btnClear">Clear</button>
</div>
</div>
</div>
</div>
</div>
<!-- Simple Editor Dialog for My Templates -->
<dialog id="ut_editor">
<form id="ut_form" novalidate="" style="min-width: min(680px, 90vw)">
<h3 style="margin:0 0 10px">Edit Template</h3>
<div class="grid" style="display:grid; grid-template-columns:1fr 1fr; gap:10px">
<label>Internal ID (letters, numbers, underscores; will be prefixed with u:)
        <input id="ute_id" pattern="[A-Za-z0-9_]{2,64}" placeholder="my_quote" required="" type="text"/>
</label>
<label>Label (shown in grid)
        <input id="ute_label" placeholder="My Quote" required="" type="text"/>
</label>
</div>
<label>Description
      <input id="ute_desc" placeholder="Local-only quote request" type="text"/>
</label>
<label>Fields (one per line as <name>:<type>[:required]) 
      <textarea id="ute_fields" placeholder="companyName:string:required
item:string:required
quantity:string" rows="4"></textarea>
</type></name></label>
<div class="grid" style="display:grid; grid-template-columns:1fr; gap:10px; margin-top:6px">
<label>Subject (use {{field}} placeholders)
        <input id="ute_subject" placeholder="Quote Request — {{ companyName }}: {{ item }}" type="text"/>
</label>
<label>Body (plain text; {{field}} placeholders allowed)
        <textarea id="ute_body" placeholder="Hello,

&gt;We’d like a quote for {{ item }} (qty {{ quantity }}).

&gt;Thanks," rows="8"></textarea>
</label>
</div>
<div class="inline" style="justify-content:flex-end; gap:8px; margin-top:10px">
<button class="btn" formnovalidate="" id="ute_cancel" type="button">Cancel</button>
<button class="btn" id="ute_save" type="button">Save</button>
</div>
</form>
</dialog>


<script>
(() => {
  const THEME = 'pastell';
  const ROOT  = document.documentElement;
  const stars = document.getElementById('stars');
  const layer = document.getElementById('petFlakes');

  // -- restore last theme on load so Pastell survives refresh (same key as app.js)
  const savedTheme = localStorage.getItem('sm_theme');
  if (savedTheme) ROOT.setAttribute('data-theme', savedTheme);

  const exts  = ['png','jpg','jpeg','webp'];
  const names = [
    ...Array.from({length:10}, (_,i)=>`cat${i?i:''}`),
    ...Array.from({length:10}, (_,i)=>`dog${i?i:''}`),
    ...Array.from({length:10}, (_,i)=>`cat${i?(' '+i):''}`),
    ...Array.from({length:10}, (_,i)=>`dog${i?(' '+i):''}`)
  ];
  const prefix = location.pathname.startsWith('/ui/') ? '/ui/' : '/';
  const candidates = [];
  for (const n of names) for (const ext of exts) candidates.push(`${prefix}pets/${n}.${ext}`);

  let enabled = false;
  let flakes  = [];
  let liveImages = [];
  let gen = 0;
  const prefersReduced = matchMedia('(prefers-reduced-motion: reduce)').matches;
  // Maintain --vh for transform-based fall end position
  function setVHVar(){
    const vh = (window.visualViewport?.height ?? window.innerHeight);
    document.documentElement.style.setProperty('--vh', vh + 'px');
  }
  setVHVar();
  addEventListener('resize', setVHVar);

  const pick = arr => arr[(Math.random()*arr.length)|0];
  const inches2 = () => (innerWidth/96)*(innerHeight/96);
  const decideCount = () => Math.max(40, Math.min(Math.round(inches2()*4), 350));

  async function loadImages(){
    const loads = await Promise.allSettled(
      candidates.map(src => new Promise((res,rej)=>{
        const im = new Image();
        im.onload = () => res(src);
        im.onerror = () => rej(src);
        im.src = src;
      }))
    );
    const ok = loads.filter(x=>x.status==='fulfilled').map(x=>x.value);
    if (!ok.length) console.warn('[Pastell] No pet images found under', prefix+'pets/');
    return ok;
  }

  function clearFlakes(){ flakes.forEach(f=>f.remove()); flakes=[]; }

  function spawnFlakes(){
    clearFlakes();
    const count = decideCount();
    const xs = [];
    const minGap = 28;
    for (let i=0;i<count;i++){
      let x, tries=0;
      do{ x=Math.random()*innerWidth; tries++; }
      while(tries<40 && xs.some(p=>Math.abs(p-x)<minGap));
      xs.push(x);
    }
    const sizeMin=18, sizeMax=26;
    xs.forEach(x=>{
      const img=document.createElement('img');
      img.className='pet-flake';
      img.src=pick(liveImages);
      img.style.width=(sizeMin+Math.random()*(sizeMax-sizeMin)).toFixed(0)+'px';

      // Column = CSS var (no absolute left during animation)
      img.style.setProperty('--x', x + 'px');

      // Hide until we know real height, then spawn just above via --startY
      img.style.visibility = 'hidden';
      const setJustAbove = () => {
        const h = img.naturalHeight || img.getBoundingClientRect().height || 40;
        const pad = 10 + Math.floor(Math.random()*6); // 10..15
        img.style.setProperty('--startY', -(h + pad) + 'px');
        img.style.visibility = 'visible';
        // restart CSS animation cleanly after setting vars
        img.style.animation='none'; void img.offsetWidth; img.style.animation='';
      };
      if (img.complete) { setJustAbove(); }
      else { img.addEventListener('load', setJustAbove, { once:true }); }

      const dur=55+Math.random()*10;
      img.style.setProperty('--rot',(Math.random()*24-12).toFixed(1)+'deg');
      img.style.setProperty('--drift',((Math.random()<0.5?-1:1)*(6+Math.random()*8)).toFixed(1)+'px');
      img.style.setProperty('--fall-dur',dur.toFixed(1)+'s');
      img.style.setProperty('--delay',(-Math.random()*dur).toFixed(2)+'s');

      img.addEventListener('click',e=>{
        e.stopPropagation();
        img.classList.add('pop');
        img.addEventListener('animationend',ev=>{
          if(ev.animationName==='petPop') recycle(img);
        },{once:true});
      });

      img.addEventListener('animationend',ev=>{
        if(ev.animationName==='petFallTop') recycle(img);
      });

      layer.appendChild(img);
      flakes.push(img);
    });

  }

  async function enable(myGen){
    if (enabled || prefersReduced) return;
    enabled=true;
    if (stars) stars.style.display='none';
    layer.style.display='block';

    if(!liveImages.length){
      const imgs=await loadImages();
      if(myGen!==gen) return;
      liveImages=imgs;
      if(!liveImages.length){ disable(myGen); return; }
    }
   if (myGen !== gen) return;

// only spawn once, never stack duplicates
if (!flakes.length) spawnFlakes();
 
  }

  function disable(myGen){
    if(myGen!==undefined && myGen!==gen) return;
    if(!enabled) return;
    enabled=false;
    clearFlakes();
    if(stars) stars.style.display='';
    layer.style.display='none';
  }

function update(){
  const isPastell = themeIsPastell();
  if (isPastell && !enabled) {
    gen++;
    enable(gen);
  } else if (!isPastell && enabled) {
    gen++;
    disable(gen);
  }
}

  function themeIsPastell(){
    return ROOT.getAttribute('data-theme')===THEME;
  }

  const mo=new MutationObserver(()=>{
    cancelAnimationFrame(update.raf);
    update.raf=requestAnimationFrame(update);
  });
  mo.observe(ROOT,{attributes:true,attributeFilter:['data-theme']});

document.getElementById('themeSelect')?.addEventListener('change', e => {
  const val = e.target.value;
  ROOT.setAttribute('data-theme', val);
  localStorage.setItem('sm_theme', val);     // persist selection (matches app.js)
});

// On resize, keep columns; only clamp if off-screen
// On resize, keep columns; only clamp if off-screen (using --x)
addEventListener('resize', () => {
  if (!enabled) return;
  for (const img of flakes) {
    const w = img.getBoundingClientRect().width || 0;
    const cs = getComputedStyle(img);
    const x = parseFloat(cs.getPropertyValue('--x')) || 0;
    const maxX = Math.max(0, innerWidth - w);
    if (x > maxX) img.style.setProperty('--x', maxX + 'px');
  }
});

  update();
  
  function recycle(img){
    img.classList.remove('pop');
    // keep same column; only move startY just above top (transform var)
    const pad = 10 + Math.floor(Math.random()*6); // 10..15
    const h = img.naturalHeight || img.getBoundingClientRect().height || 40;
    img.style.setProperty('--startY', -(h + pad) + 'px');

    // optional: tiny source shuffle, but do NOT change width/duration/--x
    if (Math.random() < 0.15) img.src = pick(liveImages);

    // restart animation cleanly
    img.style.animation='none'; void img.offsetWidth; img.style.animation='';
  }

})();
</script>
<script src="effects/starfield.js"></script>
<script src="effects/pastell_pets.js"></script>
<script src="data.js"></script>
<script src="settings.js"></script>
<script src="intents.grid.js"></script>
<script src="generate.js"></script>
<script src="user_templates.js"></script>
<script src="app.js"></script>

</body>
</html>
